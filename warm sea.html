<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n-title="warm-sea-title">수온바다</title>
    <link rel="stylesheet" href="style.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <style>
        .phone-screen {
            background-color: #CFE9FF;
            padding-bottom: 16px;
            box-sizing: border-box;
            height: auto;
            min-height: 100vh;
        }
        .header-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            width: calc(100% - 40px);
            display: flex;
            align-items: center;
            z-index: 1000;
        }
        .back-button {
            color: white;
            cursor: pointer;
            z-index: 20;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            margin-right: 10px;
        }
        .back-arrow-icon {
            width: 24px;
            height: 24px;
        }
        .header-title {
            color: white;
            font-size: 18px;
            font-weight: bold;
        }
        .language-button {
            margin-left: auto;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            position: relative;
        }
        .language-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 5px;
            background-color: #333;
            border-radius: 5px;
            padding: 5px 0;
            min-width: 100px;
            display: none;
            z-index: 9999;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        .language-dropdown div {
            padding: 8px 10px;
            color: white;
            cursor: pointer;
            white-space: nowrap;
        }
        .language-dropdown div:hover {
            background-color: #555;
        }
        .content-box {
            width: 91.8%;
            max-width: 358px;
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 80px;
            box-sizing: border-box;
            color: #333;
            font-size: 16px;
            line-height: 1.6;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        #locations-table {
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 14px;
        }
        #locations-table th, #locations-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        #locations-table th {
            background-color: #f2f2f2;
        }
        #locations-table tbody tr:hover {
            background-color: #f5f5f5;
            cursor: pointer;
        }
        #sort-by-distance-btn {
            width: 100%;
            padding: 8px;
            font-size: 14px;
            margin-bottom: 15px;
            background-color: #0EA5E9;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #sort-by-distance-btn:hover {
            background-color: #0B5383;
        }
    </style>
</head>
<body>
    <div class="phone-screen">
        <div class="header-controls">
            <div class="back-button" onclick="window.location.href='index.html'">
                <svg class="back-arrow-icon" viewBox="0 0 24 24"><path d="M15 5 L5 12 L15 19 M5 12 H20" stroke="white" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </div>
            <span class="header-title" data-i18n="warm-sea-title">수온바다</span>
            <div class="language-button">
                <span id="current-language">KO</span>
                <div class="language-dropdown">
                    <div data-lang="ko">한국어</div>
                    <div data-lang="en">English</div>
                    <div data-lang="zh">中文</div>
                </div>
            </div>
        </div>
        <div class="content-box" style="height: 350px; padding: 0; overflow: hidden;">
            <div id="map"></div>
        </div>
        <div class="content-box" style="margin-top: 16px; height: auto; text-align: left; padding: 15px;">
            <h3 style="text-align: center; margin-top:0; margin-bottom: 10px;" data-i18n="marker-list">마커 목록</h3>
            <button id="sort-by-distance-btn" data-i18n="sort-by-distance">내 위치 기준 정렬</button>
            <table id="locations-table" style="width: 100%;">
                <thead>
                    <tr>
                        <th data-i18n="name">이름</th>
                        <th data-i18n="temperature">수온</th>
                        <th data-i18n="distance">거리</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be inserted here by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
    <script src="script.js"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
    <!-- Map Initialization Script -->
    <script>
        // Data for markers
        const locations = [
            { name: "부산 자갈치시장", coords: [35.0976, 129.0302], temperature: "18.2°C", marker: null },
            { name: "서울 노량진수산시장", coords: [37.5153, 126.9423], temperature: "15.5°C", marker: null },
            { name: "강릉 주문진항", coords: [37.8913, 128.8281], temperature: "17.8°C", marker: null },
            { name: "제주 동문시장", coords: [33.5127, 126.5283], temperature: "19.1°C", marker: null }
        ];

        const southKoreaBounds = L.latLngBounds(L.latLng(33, 124), L.latLng(39, 132));
        var map = L.map('map', { maxBounds: southKoreaBounds, maxBoundsViscosity: 1.0 });
        let myLocationMarker = null;

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19, minZoom: 6, attribution: '© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        const tableBody = document.querySelector('#locations-table tbody');
        const markerGroup = [];

        function getDistance(coords1, coords2) {
            const R = 6371; // Radius of the Earth in km
            const dLat = (coords2[0] - coords1[0]) * Math.PI / 180;
            const dLon = (coords2[1] - coords1[1]) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(coords1[0] * Math.PI / 180) * Math.cos(coords2[0] * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distance in km
        }

        function renderTable() {
            tableBody.innerHTML = ''; // Clear existing rows
            locations.forEach(location => {
                const row = document.createElement('tr');
                row.style.cursor = 'pointer';
                row.innerHTML = `
                    <td>${location.name}</td>
                    <td>${location.temperature}</td>
                    <td>${location.distance ? location.distance.toFixed(1) + ' km' : ' - '}</td>
                `;
                row.addEventListener('click', () => {
                    map.setView(location.coords, 15);
                    location.marker.openPopup();
                });
                tableBody.appendChild(row);
            });
        }

        // Initial setup of markers
        function updateMarkerPopups() {
            const lang = getCurrentLanguage();
            const tempLabel = translations[lang]['temperature'] || translations['ko']['temperature'];
            locations.forEach(location => {
                if (location.marker) {
                    location.marker.setPopupContent(`<b>${location.name}</b><br>${tempLabel}: ${location.temperature}`);
                }
            });
        }
        
        locations.forEach(location => {
            const marker = L.marker(location.coords).addTo(map);
            const lang = getCurrentLanguage();
            const tempLabel = translations[lang]['temperature'] || translations['ko']['temperature'];
            marker.bindPopup(`<b>${location.name}</b><br>${tempLabel}: ${location.temperature}`);
            location.marker = marker;
            markerGroup.push(marker);
        });
        
        // Update marker popups and button text when language changes
        function updateLanguageDependentElements() {
            updateMarkerPopups();
            const lang = getCurrentLanguage();
            const sortBtn = document.getElementById('sort-by-distance-btn');
            if (sortBtn) {
                sortBtn.textContent = translations[lang]['sort-by-distance'] || translations['ko']['sort-by-distance'];
            }
            // Update my location marker popup if it exists
            if (myLocationMarker) {
                const myLocationText = translations[lang]['my-location'] || translations['ko']['my-location'];
                myLocationMarker.setPopupContent(`<b>${myLocationText}</b>`);
            }
        }
        window.addEventListener('languageChanged', updateLanguageDependentElements);

        // Initial render of the table
        renderTable();

        // Set initial map view
        if (markerGroup.length > 0) {
            const group = L.featureGroup(markerGroup);
            map.fitBounds(group.getBounds().pad(0.1));
        }

        // Sort button logic
        document.getElementById('sort-by-distance-btn').addEventListener('click', () => {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser.');
                return;
            }
            navigator.geolocation.getCurrentPosition(position => {
                const userCoords = [position.coords.latitude, position.coords.longitude];

                if (myLocationMarker) {
                    map.removeLayer(myLocationMarker);
                }
                const myLocationIcon = L.divIcon({
                    className: 'my-location-icon',
                    html: '<div style="background-color: #1E90FF; width: 14px; height: 14px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 3px #333;"></div>',
                    iconSize: [14, 14],
                    iconAnchor: [7, 7]
                });
                myLocationMarker = L.marker(userCoords, { icon: myLocationIcon }).addTo(map);
                const lang = getCurrentLanguage();
                myLocationMarker.bindPopup(`<b>${translations[lang]['my-location'] || translations['ko']['my-location']}</b>`);

                locations.forEach(loc => {
                    loc.distance = getDistance(userCoords, loc.coords);
                });
                locations.sort((a, b) => a.distance - b.distance);
                renderTable();

                const allMarkers = [...markerGroup, myLocationMarker];
                const allMarkersGroup = L.featureGroup(allMarkers);
                map.fitBounds(allMarkersGroup.getBounds().pad(0.1));
                myLocationMarker.openPopup();

            }, () => {
                alert('Unable to retrieve your location.');
            });
        });
    </script>
</body>
</html>
